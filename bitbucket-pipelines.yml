image: node:20-bookworm-slim

pipelines:
  branches:
    main:
      # run tests before deploy to ensure we still good after merging back
      # with everything else.
      - step:
          name: Run Tests
          caches:
            - node
          script:
            - npm install
            - npx -y playwright@1.42.1 install --with-deps
            - npm run test:ci
      - step:
          name: Upload image to Digital Ocean
          script:
            - export BITBUCKET_COMMIT_SHORT=$(echo $BITBUCKET_COMMIT | cut -c1-7)
            - export IMAGE_NAME=registry.digitalocean.com/polar-labs-registry/polarlabs_homepage:$BITBUCKET_COMMIT_SHORT
            - docker build -t $IMAGE_NAME .
            - docker login registry.digitalocean.com -u $CONTAINER_REGISTRY_USERNAME -p $CONTAINER_REGISTRY_PASSWORD
            - docker push $IMAGE_NAME
          services:
            - docker

  pull-requests:
    '**':
      # For now we should just test here and other necessary blocking things.
      # Linting, prettifying, etc can be done with husky on our own machines.
      # Saves bitbucket pipeline minutes.
      - step:
          name: Run Tests
          caches:
            - node
          script:
            - npm install
            - npx -y playwright@1.42.1 install --with-deps
            - npm run test:ci
