# This image is an official playwright image that already contains plawright deps,
# speeds things up not having to install them every time!
# NOTE: Make sure it matches the playwright version in package.json
image: mcr.microsoft.com/playwright:v1.42.1-jammy

pipelines:
  branches:
    main:
      # run tests before deploy to ensure we still good after merging back
      # with everything else.
      - step:
          name: Run Tests
          caches:
            - node
          script:
            - npm install
            - bin/generate-env
            - npm run test:ci
      - stage:
          name: Deploy to Production
          deployment: production
          trigger: manual
          steps:
            - step:
                name: Upload image to Digital Ocean
                script:
                  - bin/generate-env
                  - export BITBUCKET_COMMIT_SHORT=$(echo $BITBUCKET_COMMIT | cut -c1-7)
                  - export IMAGE_NAME=$IMAGE_TAG_NAME:$BITBUCKET_COMMIT_SHORT
                  - docker build -t $IMAGE_NAME .
                  - docker login $CONTAINER_REGISTRY_HOST -u $CONTAINER_REGISTRY_USERNAME -p $CONTAINER_REGISTRY_PASSWORD
                  - docker push $IMAGE_NAME
                services:
                  - docker

  pull-requests:
    '**':
      # For now we should just test here and other necessary blocking things.
      # Linting, prettifying, etc can be done with husky on our own machines.
      # Saves bitbucket pipeline minutes.
      - step:
          name: Run Tests
          caches:
            - node
          script:
            - npm install
            - bin/generate-env
            - npm run test:ci
